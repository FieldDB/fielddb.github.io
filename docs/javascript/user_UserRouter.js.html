<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>user/UserRouter.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Activities.html">Activities</a></li><li><a href="Activity.html">Activity</a></li><li><a href="App.html">App</a></li><li><a href="AppRouter.html">AppRouter</a><ul class='methods'><li data-type='method'><a href="AppRouter.html#renderDashboardOrNot">renderDashboardOrNot</a></li><li data-type='method'><a href="AppRouter.html#showAllData">showAllData</a></li><li data-type='method'><a href="AppRouter.html#showAllDataInSession">showAllDataInSession</a></li><li data-type='method'><a href="AppRouter.html#showDashboard">showDashboard</a></li><li data-type='method'><a href="AppRouter.html#showEmbeddedCorpus">showEmbeddedCorpus</a></li><li data-type='method'><a href="AppRouter.html#showEmbeddedSearch">showEmbeddedSearch</a></li><li data-type='method'><a href="AppRouter.html#showEmbeddedSession">showEmbeddedSession</a></li><li data-type='method'><a href="AppRouter.html#showFullscreenCorpus">showFullscreenCorpus</a></li><li data-type='method'><a href="AppRouter.html#showFullscreenDataList">showFullscreenDataList</a></li><li data-type='method'><a href="AppRouter.html#showFullscreenSearch">showFullscreenSearch</a></li><li data-type='method'><a href="AppRouter.html#showFullscreenSession">showFullscreenSession</a></li><li data-type='method'><a href="AppRouter.html#showFullscreenUser">showFullscreenUser</a></li></ul></li><li><a href="AudioPlayer.html">AudioPlayer</a></li><li><a href="AudioVideo.html">AudioVideo</a></li><li><a href="AudioVideoRecorder.html">AudioVideoRecorder</a></li><li><a href="AudioVideos.html">AudioVideos</a></li><li><a href="Authentication.html">Authentication</a></li><li><a href="Collection.html">Collection</a></li><li><a href="Comment.html">Comment</a></li><li><a href="Comments.html">Comments</a></li><li><a href="ComputationalLinguisticsDatum.html">ComputationalLinguisticsDatum</a></li><li><a href="Confidential.html">Confidential</a></li><li><a href="Connection.html">Connection</a><ul class='methods'><li data-type='method'><a href="Connection.html#.validateIdentifier">validateIdentifier</a></li></ul></li><li><a href="Consultant.html">Consultant</a></li><li><a href="Consultants.html">Consultants</a></li><li><a href="Contexts.html">Contexts</a></li><li><a href="ContextualizableObject.html">ContextualizableObject</a></li><li><a href="Contextualizer.html">Contextualizer</a></li><li><a href="Conversation.html">Conversation</a><ul class='methods'><li data-type='method'><a href="Conversation.html#saveAndInterConnectInApp">saveAndInterConnectInApp</a></li><li data-type='method'><a href="Conversation.html#setAsCurrentConversation">setAsCurrentConversation</a></li></ul></li><li><a href="Conversations.html">Conversations</a></li><li><a href="Corpus.html">Corpus</a></li><li><a href="CorpusMask.html">CorpusMask</a></li><li><a href="DataList.html">DataList</a></li><li><a href="DataLists.html">DataLists</a></li><li><a href="Datum.html">Datum</a></li><li><a href="DatumField.html">DatumField</a></li><li><a href="DatumFields.html">DatumFields</a></li><li><a href="Datums.html">Datums</a></li><li><a href="DatumState.html">DatumState</a></li><li><a href="DatumStates.html">DatumStates</a></li><li><a href="DatumTag.html">DatumTag</a></li><li><a href="DatumTags.html">DatumTags</a></li><li><a href="DocumentCollection.html">DocumentCollection</a></li><li><a href="ELanguages.html">ELanguages</a></li><li><a href="ExperimentDataList.html">ExperimentDataList</a></li><li><a href="Export.html">Export</a></li><li><a href="FieldDBObject.html">FieldDBObject</a><ul class='methods'><li data-type='method'><a href="FieldDBObject.html#.uuidGenerator">uuidGenerator</a></li></ul></li><li><a href="GitImport.html">GitImport</a></li><li><a href="Glosser.html">Glosser</a><ul class='methods'><li data-type='method'><a href="Glosser.html#.calculateAllAlternativeCombinations">calculateAllAlternativeCombinations</a></li><li data-type='method'><a href="Glosser.html#.removeRedundantCopies">removeRedundantCopies</a></li><li data-type='method'><a href="Glosser.html#.sortAlternatesByLessSegmentation">sortAlternatesByLessSegmentation</a></li><li data-type='method'><a href="Glosser.html#.sortAlternatesByMoreSegmentation">sortAlternatesByMoreSegmentation</a></li></ul></li><li><a href="HotKey.html">HotKey</a></li><li><a href="HotKeys.html">HotKeys</a></li><li><a href="HTML5Audio.html">HTML5Audio</a></li><li><a href="Image.html">Image</a></li><li><a href="Images.html">Images</a></li><li><a href="Import.html">Import</a></li><li><a href="LanguageDatum.html">LanguageDatum</a></li><li><a href="Lexicon.html">Lexicon</a></li><li><a href="LexiconNode.html">LexiconNode</a></li><li><a href="Participant.html">Participant</a></li><li><a href="Permission.html">Permission</a></li><li><a href="Permissions.html">Permissions</a></li><li><a href="PsycholinguisticsApp.html">PsycholinguisticsApp</a></li><li><a href="ReportBot.html">ReportBot</a><ul class='methods'><li data-type='method'><a href="ReportBot.html#schedule">schedule</a></li></ul></li><li><a href="Response.html">Response</a></li><li><a href="Search.html">Search</a></li><li><a href="Session.html">Session</a></li><li><a href="Sessions.html">Sessions</a></li><li><a href="Speaker.html">Speaker</a></li><li><a href="Stimulus.html">Stimulus</a></li><li><a href="SubExperimentDataList.html">SubExperimentDataList</a></li><li><a href="Team.html">Team</a></li><li><a href="UnicodeSymbol.html">UnicodeSymbol</a></li><li><a href="UnicodeSymbols.html">UnicodeSymbols</a></li><li><a href="User.html">User</a></li><li><a href="UserApp.html">UserApp</a></li><li><a href="UserMask.html">UserMask</a></li><li><a href="UserPreference.html">UserPreference</a></li><li><a href="UserRouter.html">UserRouter</a><ul class='methods'><li data-type='method'><a href="UserRouter.html#showCorpusDashboard">showCorpusDashboard</a></li><li data-type='method'><a href="UserRouter.html#showDashboard">showDashboard</a></li><li data-type='method'><a href="UserRouter.html#showFullscreenUser">showFullscreenUser</a></li></ul></li><li><a href="Users.html">Users</a></li><li>{String: Exercise}</li></ul><h3>Modules</h3><ul><li><a href="module-FieldDB.html">FieldDB</a></li></ul><h3>Global</h3><ul><li><a href="global.html#add">add</a></li><li><a href="global.html#clone">clone</a></li><li><a href="global.html#debugMode">debugMode</a></li><li><a href="global.html#find">find</a></li><li><a href="global.html#getMD5ForFile">getMD5ForFile</a></li><li><a href="global.html#getSanitizedDotNotationKey">getSanitizedDotNotationKey</a></li><li><a href="global.html#LexiconFactory">LexiconFactory</a></li><li><a href="global.html#sanitizeStringForFileSystem">sanitizeStringForFileSystem</a></li><li><a href="global.html#sanitizeStringForPrimaryKey">sanitizeStringForPrimaryKey</a></li><li><a href="global.html#showDiffs">showDiffs</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">user/UserRouter.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>define([
  "backbone",
  "corpus/Corpus",
  "corpus/CorpusMask",
  "user/User",
  "OPrime"
], function(
  Backbone,
  Corpus,
  CorpusMask,
  User
) {
  var UserRouter = Backbone.Router.extend( /** @lends UserRouter.prototype */ {
    /**
     * @class Routes URLs to handle the user dashboard. Mostly just
     *        shows the user a list of their corpora so they can switch
     *        between corpora.
     * @description Routes URLs to handle the user dashboard. Mostly just
     *        shows the user a list of their corpora so they can switch
     *        between corpora.
     *
     * @extends Backbone.Router
     * @constructs
     */
    initialize: function() {},

    routes: {
      "corpus/:dbname/:id": "showCorpusDashboard",
      "corpus/:dbname/": "guessCorpusIdAndShowDashboard",
      "corpus/:dbname": "guessCorpusIdAndShowDashboard",
      "login/:dbname": "showQuickAuthenticateAndRedirectToDatabase",
      "render/:render": "showDashboard",
      "": "showDashboard"
    },

    /**
     * Displays the dashboard view of the user loaded in authentication
     *
     */
    showDashboard: function(renderOrNot) {
      if (OPrime.debugMode) OPrime.debug("In showDashboard: ");
      //      $("#user-modal").modal("show");

    },
    /**
     * Displays the dashboard view of the user loaded in authentication
     *
     */
    showFullscreenUser: function() {
      if (OPrime.debugMode) OPrime.debug("In showFullscreenUser: ");
    },
    showQuickAuthenticateAndRedirectToDatabase: function(dbname) {
      window.app.set("corpus", new Corpus());
      window.app.get("authentication").syncUserWithServer(function() {
        var optionalCouchAppPath = OPrime.guessCorpusUrlBasedOnWindowOrigin(dbname);
        window.location.replace(optionalCouchAppPath + "corpus.html");
      });
    },
    guessCorpusIdAndShowDashboard: function(dbname) {
      var connection = JSON.parse(JSON.stringify(window.app.get("authentication").get("userPrivate").get("corpora")[0]));
      if (!connection) {
        return;
      }
      /* this assumes that the user's corpus connection for this pouch is not on a different server */
      connection.dbname = dbname;
      window.app.changePouch(connection, function() {
        var c = new CorpusMask();
        c.set({
          "dbname": dbname
        });
        c.id = "corpus";
        c.fetch({
          success: function(model) {
            if (OPrime.debugMode) OPrime.debug("Corpus fetched successfully", model);
            var corpusidfromCorpusMask = model.get("corpusid");
            /* Upgrade to version 1.38 */
            if (!corpusidfromCorpusMask) {
              corpusidfromCorpusMask = model.get("corpusId");
            }
            if (corpusidfromCorpusMask) {
              window.app.router.showCorpusDashboard(dbname, corpusidfromCorpusMask);
            } else {
              OPrime.bug("There was a problem loading this corpus. Please report this.");
              if (OPrime.isChromeApp()) {
                OPrime.bug("There was a problem loading this corpus, maybe it is not backed up?\n\n Attempting to back it up now...");
                /* TODO get the id of the only corpus in the database */
                window.location.replace("backup_pouches.html");
              }
            }
          },
          error: function(e, x, y) {
            if (OPrime.debugMode) OPrime.debug("Problem opening the dashboard ", e, x, y);
            var reason = "";
            if (x) {
              reason = x.reason;
            }
            if (OPrime.debugMode) OPrime.debug("There was a potential problem opening your dashboard." + reason);
          }
        });
      });
    },

    /**
     * Loads the requested corpus, and redirects the user to the corpus dashboard
     *
     * @param {String}
     *          dbname The name of the corpus this datum is from.
     */
    showCorpusDashboard: function(dbname, corpusid) {
      if (OPrime.debugMode) OPrime.debug("In showFullscreenCorpus: ");

      /*
       * If the corpusid is not specified, then try to guess it by re-routing us to the guess function
       */
      if (!corpusid) {
        window.app.router.navigate("corpus/" + dbname, {
          trigger: true
        });

        return;
      }
      if (!dbname) {
        if (OPrime.debugMode) OPrime.debug("the dbname is missing, this should never happen");
        return;
      }
      var connection = JSON.parse(JSON.stringify(window.app.get("authentication").get("userPrivate").get("corpora")[0]));
      if (!connection) {
        return;
      }
      var self = this;
      connection.dbname = dbname;
      window.app.changePouch(connection, function() {

        var c = new Corpus();
        c.set({
          "dbname": dbname
        });
        c.id = corpusid;
        c.fetch({
          success: function(model) {
            if (OPrime.debugMode) OPrime.debug("Corpus fetched successfully", model);

            c.makeSureCorpusHasADataList(function() {
              c.makeSureCorpusHasASession(function() {
                self.loadCorpusDashboard(model);
                //end success to create new data list
              }, function() {
                alert("Failed to create a session. ");
              }); //end failure to create new data list
              //end success to create new data list
            }, function() {
              alert("Failed to create a datalist. ");
            }); //end failure to create new data list

          },
          error: function(e, x, y) {
            console.log(e);
            console.log(x);
            console.log(y);
            if (self.islooping) {
              return;
            }

            self.bringCorpusToThisDevice(c, function() {
              alert("Downloaded this corpus to this device. Attempting to load the corpus dashboard.");
              self.showCorpusDashboard(dbname, corpusid);
              self.islooping = true;

            }, function(e) {
              alert("Couldn't download this corpus to this device. There was an error replicating corpus..." + e);
            });

          }
        });

      });

    },
    loadCorpusDashboard: function(c) {
      var mostRecentIds = {
        corpusid: c.id,
        datalistid: c.datalists.models[0].id,
        sessionid: c.sessions.models[0].id,
        connection: c.get("connection")
      };
      console.log("mostRecentIds", mostRecentIds);
      window.app.get("authentication").get("userPrivate").set("mostRecentIds", mostRecentIds);
      window.app.get("authentication").saveAndInterConnectInApp(function() {
        var optionalCouchAppPath = "";
        if (c.get("connection").dbname) {
          optionalCouchAppPath = OPrime.guessCorpusUrlBasedOnWindowOrigin(c.get("connection").dbname);
        }
        window.location.replace(optionalCouchAppPath + "corpus.html");
        return;
      });
    },
    bringCorpusToThisDevice: function(corpus, callback) {
      for (var x in window.app.get("authentication").get("userPrivate").get("corpora")) {
        if (window.app.get("authentication").get("userPrivate").get("corpora")[x].dbname == corpus.get("dbname")) {
          corpus.set("connection", window.app.get("authentication").get("userPrivate").get("corpora")[x]);
          window.app.set("corpus", corpus);
          window.app.get("authentication").staleAuthentication = true;
          window.app.get("authentication").syncUserWithServer(function() {
            window.app.replicateOnlyFromCorpus(null, callback);
          });
          break;
        }
      }
    },

    hideEverything: function() {
      $("#dashboard-view").hide();
      $("#datums-embedded").hide();
      $("#conversation-embedded").hide();
      $("#data-list-fullscreen").hide();
      $("#datum-container-fullscreen").hide();
      $("#conversation-container-fullscreen").hide();
      $("#corpus-embedded").hide();
      $("#corpus-fullscreen").hide();
      $("#search-fullscreen").hide();
      $("#search-embedded").hide();
      $("#session-embedded").hide();
      $("#session-fullscreen").hide();
      $('#public-user-page').hide();
      $('#user-fullscreen').hide();
      $('#import-fullscreen').hide();
      $('#data-list-embedded').hide();
    }

  });

  return UserRouter;
});
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Sat Mar 18 2017 20:02:56 GMT-0400 (EDT) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
